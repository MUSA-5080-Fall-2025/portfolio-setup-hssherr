cat("No significant hot spots found \n\n")
}
cat("Summary statistics of Distance to Hot Spot:\n")
summary(fishnet_data$dist_to_hotspot)
calc_local_morans <- function(data, var, k) {
coords <- st_coordinates(st_centroid(data))
neighbors <- knn2nb(knearneigh(coords, k = k))
weights <- nb2listw(neighbors, style = "W", zero.policy = T)
local_moran <- localmoran(data[[var]], weights)
mean_val <- mean(data[[var]], na.rm = T)
data %>%
mutate(local_i = local_moran[,1],
p_value = local_moran[,5],
is_sig = p_value < 0.05,
moran_class = case_when(!is_sig ~ "Not Significant",
local_i > 0 & .data[[var]] > mean_val ~ "High-High",
local_i > 0 & .data[[var]] <= mean_val ~ "Low-Low",
local_i < 0 & .data[[var]] > mean_val ~ "High-Low",
local_i < 0 & .data[[var]] <= mean_val ~ "Low-High",
TRUE ~ "Not Significant"))
}
# calculate local moran's I for vacant building reports in 2017
fishnet_data <- calc_local_morans(data = fishnet_data,
var = "cnt_reports_2017",
k = 5)
#| fig-width: 8
#| fig-height: 6
# Visualize hot spots
ggplot() +
geom_sf(
data = fishnet_data,
aes(fill = moran_class),
color = NA
) +
scale_fill_manual(
values = c(
"High-High" = "#d7191c",
"High-Low" = "#fdae61",
"Low-High" = "#abd9e9",
"Low-Low" = "#2c7bb6",
"Not Significant" = "gray90"
),
name = "Cluster Type"
) +
labs(
title = "Local Moran's I: Vacant/Abandoned Building Report Clusters",
subtitle = "High-High = Hot spots of disorder"
) +
theme_void()
hotspots <- fishnet_data %>%
filter(moran_class == "High-High") %>%
st_centroid()
# calculate distance from each cell to the nearest hot spot
if (nrow(hotspots) > 0) {
fishnet_data <- fishnet_data %>%
mutate(dist_to_hotspot = as.numeric(st_distance(st_centroid(fishnet_data),
hotspots %>%
st_union())))
cat("Number of hot spot cells:", nrow(hotspots), "\n\n")
} else{
fishnet_data <- fishnet_data %>%
mutate(dist_to_hotspot = 0)
cat("No significant hot spots found \n\n")
}
cat("Summary statistics of Distance to Hot Spot:\n")
summary(fishnet_data$dist_to_hotspot)
ggplot() +
geom_sf(data = chicagoBoundary, color = "grey20", fill = "transparent") +
geom_sf(data = policeDistricts, color = "grey50", fill = "transparent") +
theme_void()
test <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
plot(fishnet_data$geometry)
plot(test$geometry)
ggplot() +
geom_sf(data = fishnet_data, fill = "grey", color = "black", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "lightblue", color = "lightblue4", alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey", color = "black", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "lightblue", color = "lightblue4", alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey", color = "black", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "lightblue", color = "blue4", alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey", color = "black", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "lightblue", color = "lightblue", alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey", color = "black", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "lightblue", color = NA, alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey90", color = "grey30", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "lightblue", color = NA, alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey90", color = "grey30", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "maroon", color = NA, alpha = 0.5) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey90", color = "grey30", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "maroon", color = NA, alpha = 0.1) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey90", color = "grey30", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "maroon", color = NA, alpha = 0.2) +
theme_void()
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey90", color = "grey30", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "maroon", color = NA, alpha = 0.3) +
theme_void()
cat("Fishnet Cell Count After Filtering:", nrow(fishnet_data_pd), "\n\n")
cat("Fishnet Cell Count Prior to Filtering:", nrow(fishnet_data), "\n\n")
cat("Fishnet Cell Count After Filtering:", nrow(fishnet_data_pd), "\n\n")
cat("Fishnet Cell Count Prior to Filtering:", nrow(fishnet_data), "\n\n")
cat("Fishnet Cell Count After Filtering:", nrow(fishnet_data_pd), "\n\n")
cat("Cell Loss Percent:", round(nrow(fishnet_data_pd)/nrow(fishnet_data), 3)*100)
cat("Cell Loss Percent: ",
(1-round(nrow(fishnet_data_pd)/nrow(fishnet_data), 3))*100,
"%",
sep = "")
cat("Fishnet Cell Count Prior to Filtering:", nrow(fishnet_data), "\n\n")
cat("Fishnet Cell Count After Filtering:", nrow(fishnet_data_pd), "\n\n")
cat("Cell Loss Percent: ",
(1-round(nrow(fishnet_data_pd)/nrow(fishnet_data), 3))*100,
"%",
sep = "")
2458 - 1708
fishnet_data_pd <- st_join(fishnet_data,
policeDistricts,
join = st_within,
left = T) %>%
filter(!is.na(District))
ggplot() +
geom_sf(data = fishnet_data, fill = "grey90", color = "grey30", alpha = 0.5) +
geom_sf(data = fishnet_data_pd, fill = "maroon", color = NA, alpha = 0.3) +
labs(title = "Visualizing Fishnet Cell Loss",
subtitle = "Black = Original Fishnet, Red = Trimmed Fishnet") +
theme_void()
fishnet_model <- fishnet_data_pd %>%
st_drop_geometry() %>%
dplyr::select(fish_id, District, cnt_burglaries_2017, cnt_reports_2017, knn_reports_2017, dist_to_hotspot) %>%
na.omit()
# fit poisson regression model for 2017
model_poisson <- fishnet_model %>%
glm(cnt_burglaries_2017 ~ cnt_reports_2017, knn_reports_2017, dist_to_hotspot,
data = .,
family = "poisson")
summary(model_poisson)
# fit poisson regression model for 2017
model_poisson <- fishnet_model %>%
glm(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,
data = .,
family = "poisson")
summary(model_poisson)
6.046e-06/6.984e-06
dispersion <- sum(residuals(model_poisson,
type = "pearson")^2) / model_poisson$df.residual
cat("Dispersion Parameter:", round(disperson, 2), "\n")
dispersion <- sum(residuals(model_poisson,
type = "pearson")^2) / model_poisson$df.residual
cat("Dispersion Parameter:", round(dispersion, 2), "\n")
cat("Rule of Thumb: >1.5 typically suggests overdispersion \n")
if (dispersion > 1.5) {
cat("⚠ Overdispersion detected! Consider Negative Binomial model.\n")
} else {
cat("✓ Dispersion looks okay for Poisson model.\n")
}
# fit a negative binomial model
model_nb <- fishnet_data_pd %>%
glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017, knn_reports_2017, dist_to_hotspot,
data = .)
summary(model_nb)
# compare the AIC scores of both models (lower is better)
cat("Model Comparison:\n",
"Poisson AIC:", round(AID(model_poisson), 1), "\n",
"Negative Binomial AIC:", round(AIC(model_nb), 1))
# fit a negative binomial model
model_nb <- fishnet_data_pd %>%
glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017, knn_reports_2017, dist_to_hotspot,
data = .)
summary(model_nb)
# compare the AIC scores of both models (lower is better)
cat("Model Comparison:\n",
"Poisson AIC:", round(AIC(model_poisson), 1), "\n",
"Negative Binomial AIC:", round(AIC(model_nb), 1))
# fit a negative binomial model
model_nb <- fishnet_data_pd %>%
glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017, knn_reports_2017, dist_to_hotspot,
data = .)
summary(model_nb)
# compare the AIC scores of both models (lower is better)
cat("\n\nModel Comparison:\n",
"Poisson AIC:", round(AIC(model_poisson), 1), "\n",
"Negative Binomial AIC:", round(AIC(model_nb), 1))
# fit a negative binomial model
model_nb <- fishnet_data_pd %>%
glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,
data = .)
summary(model_nb)
# compare the AIC scores of both models (lower is better)
cat("\n\nModel Comparison:\n",
"Poisson AIC:", round(AIC(model_poisson), 1), "\n",
"Negative Binomial AIC:", round(AIC(model_nb), 1))
1.029e-05/2.042e-05
districts <- unique(fishnet_model$District)
cv_results <- tibble()
for (i in seq_along(districts) {
districts <- unique(fishnet_model$District)
cv_results <- tibble()
for (i in seq_along(districts)) {
test_district <- districts[i]
# split into training and testing data
train_data <- fishnet_model %>% filter(District != test_district)
test_data <- fishnet_model %>% filter(District == test_district)
# fit model on training data
model_cv <- fishnet_model %>%
glm.nb(cnt_burglaries_2017 ~
cnt_reports_2017 +
knn_reports_2017 +
dist_to_hotspot,
data = .)
# predict on test data
test_data <- test_data %>%
mutate(pred = predict(model_cv, test_data, type = "response"))
# calculate metrics
mae <- mean(abs(test_data$cnt_burglaries_2017 - test_data$pred))
rmse <- sqrt(mean((test_data$cnt_burglaries_2017 - test_data$pred)^2))
# store results
cv_results <- bind_rows(cv_results,
tibble(fold = i,
test_district = test_district,
n_test = nrow(test_data),
mae - mae,
rmse = rmse))
}
View(cv_results)
districts <- unique(fishnet_model$District)
cv_results <- tibble()
for (i in seq_along(districts)) {
test_district <- districts[i]
# split into training and testing data
train_data <- fishnet_model %>% filter(District != test_district)
test_data <- fishnet_model %>% filter(District == test_district)
# fit model on training data
model_cv <- fishnet_model %>%
glm.nb(cnt_burglaries_2017 ~
cnt_reports_2017 +
knn_reports_2017 +
dist_to_hotspot,
data = .)
# predict on test data
test_data <- test_data %>%
mutate(pred = predict(model_cv, test_data, type = "response"))
# calculate metrics
mae <- mean(abs(test_data$cnt_burglaries_2017 - test_data$pred))
rmse <- sqrt(mean((test_data$cnt_burglaries_2017 - test_data$pred)^2))
# store results
cv_results <- bind_rows(cv_results,
tibble(fold = i,
test_district = test_district,
n_test = nrow(test_data),
mae = mae,
rmse = rmse))
}
# view results of the spatial cross-validation
cv_results %>%
arrange(desc(mae)) %>%
kable(digits = 2,
caption = "LOGO CV Results by Police District") %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# fit final model on all data
final_model <- fishnet_model %>%
glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,
data = .)
# add predictions to the fishnet
fishnet_data_pd <- fishnet_data_pd %>%
mutate(pred_nb = predict(final_model, fishnet_model, type = "response")[match(fish_id, fishnet_model$fish_id)])
# add KDE predictions (normalized to the same scale as counts)
kde_sum <- sum(fishnet_data_pd$kde_value, na.rm = T)
count_sum <- sum(fishnet_data_pd$cnt_burglaries_2017, na.rm = T)
fishnet_data_pd <- fishnet_data_pd %>%
mutate(pred_kde = (kde_value/kde_sum) * count_sum)
View(fishnet_data_pd)
# fit final model on all data
final_model <- fishnet_model %>%
glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,
data = .)
# add predictions to the fishnet
fishnet_data_pd <- fishnet_data_pd %>%
mutate(pred_nb = predict(final_model, fishnet_model, type = "response")[match(fish_id, fishnet_model$fish_id)])
# add KDE predictions (normalized to the same scale as counts)
kde_sum <- sum(fishnet_data_pd$kde_value, na.rm = T)
count_sum <- sum(fishnet_data_pd$cnt_burglaries_2017, na.rm = T)
fishnet_data_pd <- fishnet_data_pd %>% mutate(pred_kde = (kde_value/kde_sum) * count_sum)
View(fishnet_data_pd)
#| fig-width: 12
#| fig-height: 4
# Create three maps
p1 <- ggplot() +
geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +
scale_fill_viridis_c(name = "Count", option = "plasma", limits = c(0, 15)) +
labs(title = "Actual Burglaries") +
theme_crime()
#| fig-width: 12
#| fig-height: 4
# Create three maps
p1 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = cnt_burglaries_2017), color = NA) +
scale_fill_viridis_c(name = "Count", option = "plasma", limits = c(0, 15)) +
labs(title = "Actual Burglaries") +
theme_crime()
#| fig-width: 12
#| fig-height: 4
# Create three maps
p1 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = cnt_burglaries_2017), color = NA) +
scale_fill_viridis_c(name = "Count", option = "plasma", limits = c(0, 15)) +
labs(title = "Actual Burglaries") +
theme_void()
p2 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = pred_nb), color = NA) +
scale_fill_viridis_c(name = "Predicted", option = "plasma", limits = c(0, 15)) +
labs(title = "Model Predictions (Neg. Binomial)") +
theme_void()
p3 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = pred_kde), color = NA) +
scale_fill_viridis_c(name = "Predicted", option = "plasma", limits = c(0, 15)) +
labs(title = "KDE Baseline Predictions") +
theme_void()
p1 + p2 + p3 +
plot_annotation(
title = "Actual vs. Predicted Burglaries",
subtitle = "Does our complex model outperform simple KDE?"
)
# Calculate performance metrics
comparison <- fishnet_data_pd %>%
st_drop_geometry() %>%
filter(!is.na(pred_nb), !is.na(pred_kde)) %>%
summarize(
model_mae = mean(abs(cnt_burglaries_2017 - pred_nb)),
model_rmse = sqrt(mean((cnt_burglaries_2017 - pred_nb)^2)),
kde_mae = mean(abs(cnt_burglaries_2017 - pred_kde)),
kde_rmse = sqrt(mean((cnt_burglaries_2017 - pred_kde)^2))
)
comparison %>%
pivot_longer(everything(), names_to = "metric", values_to = "value") %>%
separate(metric, into = c("approach", "metric"), sep = "_") %>%
pivot_wider(names_from = metric, values_from = value) %>%
kable(
digits = 2,
caption = "Model Performance Comparison"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
#| fig-width: 10
#| fig-height: 5
# Calculate errors
fishnet_data_pd <- fishnet_data_pd %>%
mutate(
error_nb = cnt_burglaries_2017 - pred_nb,
error_kde = cnt_burglaries_2017 - pred_kde,
abs_error_nb = abs(error_nb),
abs_error_kde = abs(error_kde)
)
# Map errors
p1 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = error_nb), color = NA) +
scale_fill_gradient2(
name = "Error",
low = "#2166ac", mid = "white", high = "#b2182b",
midpoint = 0,
limits = c(-10, 10)
) +
labs(title = "Model Errors (Actual - Predicted)") +
theme_void()
p2 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = abs_error_nb), color = NA) +
scale_fill_viridis_c(name = "Abs. Error", option = "magma") +
labs(title = "Absolute Model Errors") +
theme_void()
p1 + p2
p2 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = abs_error_nb), color = NA) +
scale_fill_viridis_c(name = "Abs. Error", option = "plasma") +
labs(title = "Absolute Model Errors") +
theme_void()
#| fig-width: 10
#| fig-height: 5
# Calculate errors
fishnet_data_pd <- fishnet_data_pd %>%
mutate(
error_nb = cnt_burglaries_2017 - pred_nb,
error_kde = cnt_burglaries_2017 - pred_kde,
abs_error_nb = abs(error_nb),
abs_error_kde = abs(error_kde)
)
# Map errors
p1 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = error_nb), color = NA) +
scale_fill_gradient2(
name = "Error",
low = "#2166ac", mid = "white", high = "#b2182b",
midpoint = 0,
limits = c(-10, 10)
) +
labs(title = "Model Errors (Actual - Predicted)") +
theme_void()
p2 <- ggplot() +
geom_sf(data = fishnet_data_pd, aes(fill = abs_error_nb), color = NA) +
scale_fill_viridis_c(name = "Abs. Error", option = "plasma") +
labs(title = "Absolute Model Errors") +
theme_void()
p1 + p2
# summary statistics for burglaries
cat("Summary Statistics for Burglaries (2017):\n")
summary(fishnet_data$cnt_burglaries_2017)
cat("Percent of Cells with No Burglaries: ",
round(sum(fishnet_data$cnt_burglaries_2017 == 0) / nrow(fishnet_data), 3)*100,
"%\n\n",
sep = "")
# summary statistics for reports 2017
cat("Summary Statistics for Vacant Building Reports (2017):\n")
summary(fishnet_data$cnt_reports_2017)
cat("Percent of Cells with No Vacant Building Reports: ",
round(sum(fishnet_data$cnt_reports_2017 == 0) / nrow(fishnet_data), 3)*100,
"%\n\n",
sep = "")
# summary statistics for reports 2018
cat("Summary Statistics for Vacant Building Reports (2018):\n")
summary(fishnet_data$cnt_reports_2018)
cat("Percent of Cells with No Vacant Building Reports: ",
round(sum(fishnet_data$cnt_reports_2018 == 0) / nrow(fishnet_data), 3)*100,
"%\n\n",
sep = "")
# Create nice summary table
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
across(where(is.numeric), ~round(., 3))
)
model_summary %>%
kable(
caption = "Final Negative Binomial Model Coefficients (Exponentiated)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = "Rate ratios > 1 indicate positive association with burglary counts."
)
model_summary %>%
kable(
caption = "Final Negative Binomial Model Coefficients (Exponentiated)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = "Rate ratios > 1 indicate positive association with burglary counts."
)
exp(-9.871e-04)
1-0.999
0.001*100
setwd("~/GitHub/portfolio-setup-hssherr")
