{"title":"Assignment 4: Spatial Predictive Analysis","markdown":{"yaml":{"title":"Assignment 4: Spatial Predictive Analysis","subtitle":"Predictive Spatial Modeling for 311 Service Requests in Chicago","author":"Henry Sywulak-Herr","date":"today","format":{"html":{"code-fold":"show","toc":true,"toc-location":"left","theme":"cosmo","embed-resources":true}},"execute":{"warning":false,"message":false},"editor":{"markdown":{"wrap":72}}},"headingText":"Introduction","containsRefs":false,"markdown":"\n\nLoad Packages & Set Seed\n\n```{r warning=FALSE}\nlibrary(pacman)\np_load(tidyverse, sf, viridis, terra, spdep, FNN, MASS, spatstat.geom, spatstat.explore,\n       viridis, patchwork, knitr, kableExtra, classInt)\n\nset.seed(1234)\n```\n\n\nThis analysis will create a spatial predictive model for burglaries in\nChicago, IL based on 311 calls that report the locations of vacant\nand/or abandoned buildings. The hypothesis behind this 311 call category\nchoice is that reports of vacant buildings could indicate areas of the\ncity that are in poor repair (broken lighting, poor street\ncleaning/maintenance, etc.) and with less functional surveillance\nequipment in the area. Please note that there are inherent biases in the\nuse of 311 call data. For example, calls might be less likely to be made\nby marginalized communities who have been historically persecuted by law\nenforcement compared to more white, affluent communities. Furthermore,\nknowledge of how to make 311 calls or what the system's intended purpose\nis might not be equally distributed across Chicago, leading to a spatial\nimbalance of calls across the region.\n\n## Part 1: Data Loading & Exploration\n\nLoading Chicago police districts for cross-validation later on, police\nbeats as a smaller administrative boundary, and the boundary of Chicago\nto create a fishnet, utilizing the coordinate system ESRI: 102271\n(Illinois State Plane East, NAD83, US Feet).\n\n```{r}\n\n# Load police districts (used for spatial cross-validation)\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\", quiet = T) %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n\n# Load police beats (smaller administrative units)\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\", quiet = T) %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n\n# Load Chicago boundary\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\", quiet = T) %>%\n  st_transform('ESRI:102271')\n```\n\nLoad burglaries data:\n\n```{r}\nburglaries <- st_read(\"./data/burglaries.shp\", quiet = T) %>% \n  st_transform('ESRI:102271')\n\n# filter out 2018 burglaries to isolate 2017 data (no other years present)\n# spatially filter to those within Chicago's boundary\nburglaries_2017 <- burglaries %>% \n  filter(year(Date) != 2018) %>% \n  st_filter(chicagoBoundary, .predicate = st_within)\n\ncat(\"Number of Burglaries:\", nrow(burglaries_2017))\n```\n\n```{r}\nggplot() +\n  geom_sf(data = chicagoBoundary, color = \"grey20\", fill = \"transparent\") +\n  geom_sf(data = burglaries_2017, color = \"maroon\", size = 0.25, alpha = 0.1) +\n  labs(title = \"Spatial Distribution of Burglaries\",\n       subtitle = \"Chicago, IL\") +\n  theme_void()\n  \n```\n\nLoad 311 Vacant and/or Abandoned Building reports. This dataset will be\nreferred to as \"Vacant Building Reports\" for the remainder of this\nreport:\n\n```{r}\nreports <- read_csv(\"./data/Vacant_and_Abandoned_Buildings_Reported.csv\", show_col_types = F)\n\n# filter out only 2017 reports\nreports_2017 <- reports %>% \n  filter(endsWith(`DATE SERVICE REQUEST WAS RECEIVED`, \"2017\"))\n\n# filter out 2018 reports for later\nreports_2018 <- reports %>% \n  filter(endsWith(`DATE SERVICE REQUEST WAS RECEIVED`, \"2018\"))\n\n\n```\n\n```{r}\n# remove rows without coordinate data and create a spatial point sf of the reports df\n# filter dataset to the extent of Chicago's boundary\nreports_2017_sf <- reports_2017 %>% \n  filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>% \n  st_as_sf(coords = c(\"LONGITUDE\", \"LATITUDE\"),\n           crs = 4326) %>% \n  st_transform(\"ESRI:102271\") %>% \n  st_filter(chicagoBoundary, .predicate = st_within)\n\n# filter dataset to the extent of Chicago's boundary\nreports_2018_sf <- reports_2018 %>% \n  filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>% \n  st_as_sf(coords = c(\"LONGITUDE\", \"LATITUDE\"),\n           crs = 4326) %>% \n  st_transform(\"ESRI:102271\") %>% \n  st_filter(chicagoBoundary, .predicate = st_within)\n\ncat(\"Number of Reports of Vacant/Abandoned Buildings (2017):\", nrow(reports_2017_sf), \"\\n\\n\")\ncat(\"Number of Reports of Vacant/Abandoned Buildings (2018):\", nrow(reports_2018_sf))\n```\n\n```{r}\nggplot() +\n  geom_sf(data = chicagoBoundary, color = \"grey20\", fill = \"transparent\") +\n  geom_sf(data = reports_2017_sf, color = \"orange\", size = 0.1, alpha = 0.1) +\n  geom_sf(data = burglaries_2017, color = \"maroon\", size = 0.25, alpha = 0.2) +\n  labs(title = \"Spatial Distribution of Burglaries and Vacant Building Reports\",\n       subtitle = \"Chicago, IL\") +\n  theme_void()\n```\n\nVisually, burglaries seem to be spatially correlated to the locations of\nvacant building reports. However, the extent of these reports seems to\nextend beyond the greatest concentrations of burglaries, which could\ninfluence the model later on.\n\n## Part 2: Fishnet Grid Creation\n\n```{r}\n# create a 500x500m fishnet based on the chicago boundary\nfishnet <- st_make_grid(chicagoBoundary,\n                        cellsize = 500,\n                        square = T) %>% \n  st_as_sf() %>% \n  mutate(fish_id = row_number()) %>% \n  rename(geometry = x) %>%\n  st_as_sf() %>% \n  st_filter(chicagoBoundary, .predicate = st_intersects)\n```\n\n```{r}\nggplot() +\n  geom_sf(data = chicagoBoundary, color = \"grey20\", fill = \"transparent\") +\n  geom_sf(data = fishnet, color = \"grey50\", fill = \"transparent\") +\n  labs(title = \"500x500m Fishnet Grid for Chicago\") +\n  theme_void()\n```\n\nNow that a fishnet has been created, we can aggregate burglaries and\nvacant building reports to them, visualize them more effectively and\nmodel their correlation with burglaries.\n\n```{r include=FALSE}\n# spatially join fishnet ids to burglary and 311 report records for both 2017 and 2018\n# generate count per fishnet cell\nburglaries_2017_fishnet <- st_join(burglaries_2017, fishnet, join = st_within) %>% \n  st_drop_geometry() %>% \n  group_by(fish_id) %>%\n  summarise(cnt_burglaries_2017 = n())\nreports_2017_fishnet <- st_join(reports_2017_sf, fishnet, join = st_within) %>% \n  st_drop_geometry() %>% \n  group_by(fish_id) %>%\n  summarise(cnt_reports_2017 = n())\nreports_2018_fishnet <- st_join(reports_2018_sf, fishnet, join = st_within) %>% \n  st_drop_geometry() %>% \n  group_by(fish_id) %>%\n  summarise(cnt_reports_2018 = n())\n\n# join values back to the fishnet, replacing NAs with 0\nfishnet_data <- list(fishnet,\n                     burglaries_2017_fishnet,\n                     reports_2017_fishnet,\n                     reports_2018_fishnet) %>% \n  reduce(left_join) %>%\n  mutate(across(where(is.numeric), ~ ifelse(is.na(.), 0, .)))\n```\n\n```{r}\n# transform 2017 data \nfishnet_2017_data_long <- fishnet_data %>%\n  dplyr::select(-cnt_reports_2018) %>% \n  pivot_longer(cols = c(cnt_burglaries_2017, cnt_reports_2017), names_to = \"var\", values_to = \"value\")\n\nggplot(fishnet_2017_data_long) +\n  geom_sf(aes(fill = value), color = NA) +\n  facet_wrap(~ var) +\n  labs(title = \"Distribution of Burglaries and Reports across Chicago\",\n       subtitle = \"Visualized as the Square Root of Counts per Fishnet Cell\") +\n  scale_fill_viridis_c(option = \"plasma\", trans = \"sqrt\",\n                       name = \"Sqrt of Count\") +\n  theme_void()\n```\n\nWhile there seem to be matching areas of high counts in South Chicago,\nthere is a notable lack of reports in North Chicago that do not match\nhigher counts of burglaries in the same area.\n\n```{r}\n# summary statistics for burglaries\ncat(\"Summary Statistics for Burglaries (2017):\\n\")\nsummary(fishnet_data$cnt_burglaries_2017)\ncat(\"Percent of Cells with No Burglaries: \",\n    round(sum(fishnet_data$cnt_burglaries_2017 == 0) / nrow(fishnet_data), 3)*100,\n    \"%\\n\\n\",\n    sep = \"\")\n\n# summary statistics for reports 2017\ncat(\"Summary Statistics for Vacant Building Reports (2017):\\n\")\nsummary(fishnet_data$cnt_reports_2017)\ncat(\"Percent of Cells with No Vacant Building Reports: \",\n    round(sum(fishnet_data$cnt_reports_2017 == 0) / nrow(fishnet_data), 3)*100,\n    \"%\\n\\n\",\n    sep = \"\")\n\n# summary statistics for reports 2018\ncat(\"Summary Statistics for Vacant Building Reports (2018):\\n\")\nsummary(fishnet_data$cnt_reports_2018)\ncat(\"Percent of Cells with No Vacant Building Reports: \",\n    round(sum(fishnet_data$cnt_reports_2018 == 0) / nrow(fishnet_data), 3)*100,\n    \"%\\n\\n\",\n    sep = \"\")\n```\n\nThere are approximately twice as many fishnet cells for both 2017 and\n2018 that have no vacant building reports compared to those that have no\nburglaries, which is indicative of the wider spatial distribution of\nburglaries.\n\n## Part 3: Spatial Features\n\n### 3.1 - Kernel Density Estimation of Burglaries\n\nCalculate a Kernel Density Estimation (KDE) baseline as a null\nhypothesis to demonstrate a scenario where burglaries occur in 2018\nsimply where they happened to occur in 2017. KDE spreads the value of a\npoint (a single burglary) over a radius (1 kilometer) with the greatest\nshare of the value close to the center of the point. By taking the mean\nvalue within a fishnet cell, we can get a distance-weighted, smoothed\nsense for how concentrated burglaries are in an area.\n\n```{r}\n\n# convert burglaries to ppp format for use with the spatstat package\nburglaries_2017_ppp <- as.ppp(st_coordinates(burglaries_2017),\n                         W = as.owin(st_bbox(chicagoBoundary)))\n\n# calculate KDE values for burglary points\nkde_burglaries <- density.ppp(burglaries_2017_ppp,\n                              sigma = 1000,\n                              edge = T)\n\n# convert KDE values to a raster\nkde_raster <- rast(kde_burglaries)\n\n# extract mean KDE values from the spatial raster to the fishnet grid\nfishnet_data <- fishnet_data %>% \n  mutate(kde_value = terra::extract(kde_raster,\n                                    vect(fishnet_data),\n                                    fun = mean,\n                                    na.rm = T)[,2])\n```\n\n```{r}\nggplot() +\n  geom_sf(data = fishnet_data, aes(fill = kde_value), color = NA) +\n  scale_fill_viridis_c(name = \"KDE Value\",\n                       option = \"plasma\") +\n  labs(title = \"Kernel Density Estimation Baseline\",\n       subtitle = \"Simple spatial smoothing of burglary locations\") +\n  theme_void()\n```\n\nThe KDE yields a map of burglary hot spots, where the influence of each\nburglary has been smoothed out and averaged. This provides a good sense\nof where generally burglaries happen, but this method also\nover-estimates where burglaries happen due to the indiscriminate nature\nof smoothing over a uniform 1km buffer.\n\n### 3.2 - k-Nearest Neighbor to Reports\n\n```{r warning=FALSE}\n\n# calculate coordinates of fishnet cells and the report locations\nfishnet_coords <- st_coordinates(st_centroid(fishnet_data))\nreports_coords <- st_coordinates(st_centroid(reports_2017_sf))\n\n# calculate k nearest neighbors and distances\nnn_result <- get.knnx(reports_coords, fishnet_coords, k = 3)\n\n# join values to the fishnet\nfishnet_data <- fishnet_data %>% \n  mutate(knn_reports_2017 = rowMeans(nn_result$nn.dist))\n\nsummary(fishnet_data$knn_reports_2017)\n```\n\nThe mean distance from the center of a fishnet cell to a report of a\nvacant building is approximately 790 meters. The value for k-nearest\nneighbor is an indicator of the average distance to the closest three\nreports of a vacant building. This is more descriptive than a simple\ncount within a fishnet cell's boundary since, for those that have no\nreports within them, there will still be a descriptive distance value to\nthe nearest reports.\n\n### 3.3 - Distance to Hot Spots (Local Moran's I)\n\n```{r warning=FALSE}\ncalc_local_morans <- function(data, var, k) {\n  coords <- st_coordinates(st_centroid(data))\n  neighbors <- knn2nb(knearneigh(coords, k = k))\n  weights <- nb2listw(neighbors, style = \"W\", zero.policy = T)\n  \n  local_moran <- localmoran(data[[var]], weights)\n  \n  mean_val <- mean(data[[var]], na.rm = T)\n  \n  data %>% \n    mutate(local_i = local_moran[,1],\n           p_value = local_moran[,5],\n           is_sig = p_value < 0.05,\n           moran_class = case_when(!is_sig ~ \"Not Significant\",\n                                   local_i > 0 & .data[[var]] > mean_val ~ \"High-High\",\n                                   local_i > 0 & .data[[var]] <= mean_val ~ \"Low-Low\",\n                                   local_i < 0 & .data[[var]] > mean_val ~ \"High-Low\",\n                                   local_i < 0 & .data[[var]] <= mean_val ~ \"Low-High\",\n                                   TRUE ~ \"Not Significant\"))\n}\n\n# calculate local moran's I for vacant building reports in 2017\nfishnet_data <- calc_local_morans(data = fishnet_data,\n                                  var = \"cnt_reports_2017\",\n                                  k = 5)\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 6\n\n# Visualize hot spots\nggplot() +\n  geom_sf(\n    data = fishnet_data, \n    aes(fill = moran_class), \n    color = NA\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"High-High\" = \"#d7191c\",\n      \"High-Low\" = \"#fdae61\",\n      \"Low-High\" = \"#abd9e9\",\n      \"Low-Low\" = \"#2c7bb6\",\n      \"Not Significant\" = \"gray90\"\n    ),\n    name = \"Cluster Type\"\n  ) +\n  labs(\n    title = \"Local Moran's I: Vacant/Abandoned Building Report Clusters\",\n    subtitle = \"High-High = Hot spots of disorder\"\n  ) +\n  theme_void()\n```\n\n```{r warning=FALSE}\nhotspots <- fishnet_data %>% \n  filter(moran_class == \"High-High\") %>% \n  st_centroid()\n\n# calculate distance from each cell to the nearest hot spot\nif (nrow(hotspots) > 0) {\n  fishnet_data <- fishnet_data %>% \n    mutate(dist_to_hotspot = as.numeric(st_distance(st_centroid(fishnet_data),\n                                                    hotspots %>% \n                                                      st_union())))\n  cat(\"Number of hot spot cells:\", nrow(hotspots), \"\\n\\n\")\n} else{\n  fishnet_data <- fishnet_data %>% \n    mutate(dist_to_hotspot = 0)\n  cat(\"No significant hot spots found \\n\\n\")\n}\n\ncat(\"Summary statistics of Distance to Hot Spot:\\n\")\nsummary(fishnet_data$dist_to_hotspot)\n```\n\nIn this scenario, Local Moran's I is a measurement of how spatially\ncorrelated burglary counts and report counts are, with fishnet cells\nthat themselves have high values for both variables and are located near\nfishnet cells with similarly high values are denoted as \"high-high\"\ncells, or hot spots. Cells for which the converse is true (low values\nfor both) are referred to as cold spots. Analyzing how significant this\nspatial correlation is and calculating the distance of each fishnet cell\nto its closest neighboring hot spot cell allows for us to understand how\neach cell is related to more regional spatial patterns, as opposed to\nthe k-nearest neighbors variable which illustrates hyper-localized\nspatial patterns.\n\n## Part 4: Count Regression Models\n\n### 4.1 - Join police districts for cross-validation later on\n\n```{r}\nfishnet_data_pd <- st_join(fishnet_data,\n                        policeDistricts,\n                        join = st_within,\n                        left = T) %>% \n  filter(!is.na(District))\n\nggplot() +\n  geom_sf(data = fishnet_data, fill = \"grey90\", color = \"grey30\", alpha = 0.5) +\n  geom_sf(data = fishnet_data_pd, fill = \"maroon\", color = NA, alpha = 0.3) +\n  labs(title = \"Visualizing Fishnet Cell Loss\",\n       subtitle = \"Black = Original Fishnet, Red = Trimmed Fishnet\") +\n  theme_void()\n```\n\n```{r}\ncat(\"Fishnet Cell Count Prior to Filtering:\", nrow(fishnet_data), \"\\n\\n\")\ncat(\"Fishnet Cell Count After Filtering:\", nrow(fishnet_data_pd), \"\\n\\n\")\ncat(\"Cell Loss Percent: \",\n    (1-round(nrow(fishnet_data_pd)/nrow(fishnet_data), 3))*100,\n    \"%\",\n    sep = \"\")\n```\n\nIn order to accurately perform spatial cross-validation later in the\nanalysis, we need to isolate only those fishnet cells that are entirely\nwithin each of Chicago's police districts. This results in an\napproximately 30% loss in data, with 750 cells omitted.\n\n### 4.2 - Poisson Regression\n\nPoisson Regression is optimal for this modeling approach, since the\ndependent variable (burglaries) is a count variable.\n\n```{r}\n# extract variables to be used for modeling and remove spatial column\nfishnet_model <- fishnet_data_pd %>%\n  st_drop_geometry() %>% \n  dplyr::select(fish_id,\n                District,\n                cnt_burglaries_2017,\n                cnt_reports_2017,\n                knn_reports_2017,\n                dist_to_hotspot) %>% \n  na.omit()\n```\n\n```{r}\n# fit poisson regression model for 2017\nmodel_poisson <- fishnet_model %>% \n  glm(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,\n      data = .,\n      family = \"poisson\")\n\nsummary(model_poisson)\n```\n\nA poisson regression analysis yields coefficients that are positive for\nthe count of reports and distance to the nearest hot spot cell\nvariables, while negative for the k-nearest neighbor variable. These\ncoefficients make sense for the count variable (greater count of reports\n= increased likelihood of burglaries) and the k-nearest neighbor\nvariable (greater distance to a report = greater of burglaries).\nHowever, the coefficient for distance to a hot spot does not make sense\n(increased distance to a hots pot = more instances of burglaries). This\ncoefficient also is not statistically significant (p \\> 0.05) and has a\nhigh standard error value equivalent to 86.5% of the coefficient.\n\n### 6.2 - Check for Overdispersion\n\n```{r}\ndispersion <- sum(residuals(model_poisson,\n                            type = \"pearson\")^2) / model_poisson$df.residual\ncat(\"Dispersion Parameter:\", round(dispersion, 2), \"\\n\")\ncat(\"Rule of Thumb: >1.5 typically suggests overdispersion \\n\")\n\nif (dispersion > 1.5) {\n  cat(\"⚠ Overdispersion detected! Consider Negative Binomial model.\\n\")\n} else {\n  cat(\"✓ Dispersion looks okay for Poisson model.\\n\")\n}\n```\n\nThis model violates the assumption that the mean of the dependent\nvariable is equal to its variance, which is typically not true for crime\ndatasets. A negative binomial model should be calculated to see if it\npredicts better.\n\n### 6.3 - Negative Binomial Regression\n\n```{r}\n# fit a negative binomial model\nmodel_nb <- fishnet_data_pd %>%\n  glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,\n         data = .)\n\nsummary(model_nb)\n\n# compare the AIC scores of both models (lower is better)\ncat(\"\\n\\nModel Comparison:\\n\", \n    \"Poisson AIC:\", round(AIC(model_poisson), 1), \"\\n\",\n    \"Negative Binomial AIC:\", round(AIC(model_nb), 1))\n```\n\nThe negative binomial model has an improved AIC value, and while its\ncoefficients follow the same sign pattern as before where the sign for\ndistance to the nearest hot spot doesn't make sense, it is now\nsignificant (p \\< 0.05) with a standard error that is slightly improved\nat 50.4% of the coefficient value. This tells us that the negative\nbinomial model is better at modeling burglary counts since it introduces\na dispersion parameter that relaxes the assumption of the poisson\nregression that mean = variance.\n\n## Part 5: Spatial Cross-Validation (2017)\n\nIn order to prevent information leakage between neighboring fishnet\ncells in a normal cross-validation procedure due their spatial\nrelationships to each other, the following code performs a\nLeave-One-Group-Out (LOGO) Cross-Validation that will divide the dataset\nup based on police district and progressively leave each one out one by\none, training a negative binomial model on the remaining districts.\n\n```{r}\ndistricts <- unique(fishnet_model$District)\ncv_results <- tibble()\n\nfor (i in seq_along(districts)) {\n  test_district <- districts[i]\n  \n  # split into training and testing data\n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data <- fishnet_model %>% filter(District == test_district)\n  \n  # fit model on training data\n  model_cv <- fishnet_model %>%\n    glm.nb(cnt_burglaries_2017 ~ \n           cnt_reports_2017 + \n           knn_reports_2017 + \n           dist_to_hotspot,\n           data = .)\n  \n  # predict on test data\n  test_data <- test_data %>% \n    mutate(pred = predict(model_cv, test_data, type = \"response\"))\n  \n  # calculate metrics\n  mae <- mean(abs(test_data$cnt_burglaries_2017 - test_data$pred))\n  rmse <- sqrt(mean((test_data$cnt_burglaries_2017 - test_data$pred)^2))\n  \n  # store results\n  cv_results <- bind_rows(cv_results,\n                          tibble(fold = i,\n                                 test_district = test_district,\n                                 n_test = nrow(test_data),\n                                 mae = mae,\n                                 rmse = rmse))\n}\n```\n\n```{r}\n# view results of the spatial cross-validation\ncv_results %>% \n  arrange(desc(mae)) %>% \n  kable(digits = 2,\n       caption = \"LOGO CV Results by Police District\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n## Part 6: Model Evaluation\n\n### 6.1 - Generate Final Predictions\n\n```{r}\n# fit final model on all data\nfinal_model <- fishnet_model %>% \n  glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,\n         data = .)\n\n# add predictions to the fishnet\nfishnet_data_pd <- fishnet_data_pd %>% \n  mutate(pred_nb = predict(final_model, fishnet_model, type = \"response\")[match(fish_id, fishnet_model$fish_id)])\n\n# add KDE predictions (normalized to the same scale as counts)\nkde_sum <- sum(fishnet_data_pd$kde_value, na.rm = T)\ncount_sum <- sum(fishnet_data_pd$cnt_burglaries_2017, na.rm = T)\nfishnet_data_pd <- fishnet_data_pd %>% mutate(pred_kde = (kde_value/kde_sum) * count_sum)\n```\n\n```{r}\n# create a summary table of the model's coefficients\nmodel_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%\n  mutate(\n    across(where(is.numeric), ~round(., 3))\n  )\n\nmodel_summary %>%\n  kable(\n    caption = \"Final Negative Binomial Model Coefficients (Exponentiated)\",\n    col.names = c(\"Variable\", \"Rate Ratio\", \"Std. Error\", \"Z\", \"P-Value\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\")) %>%\n  footnote(\n    general = \"Rate ratios > 1 indicate positive association with burglary counts.\"\n  )\n```\n\nThe final model coefficients, when exponentiated, indicate that within a\nfishnet cell an increase of one report of an abandoned/vacant building\nresults in a 4.6% increase in burglaries, a one unit increase in mean\ndistance from the centroid of a fishnet cell to the nearest three\nreports of an abandoned/vacant building results in a 0.1% decrease in\nburglaries, and distance to the nearest hot spot has no effect on the\nnumber of burglaries within that fishnet cell.\n\n```{r}\n#| fig-width: 12\n#| fig-height: 4\n\n# Create three maps\np1 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = cnt_burglaries_2017), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Actual Burglaries\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = pred_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Model Predictions (Neg. Binomial)\") +\n  theme_void()\n\np3 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = pred_kde), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"KDE Baseline Predictions\") +\n  theme_void()\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Actual vs. Predicted Burglaries\",\n    subtitle = \"Does our complex model outperform simple KDE?\"\n  )\n```\n\nIt does not appear that the negative binomial model is doing a good job\nof predicting burglaries in North Chicago, as was previously noted in\nthis report. The negative binomial model also generally seems to be\nunder-predicting counts across all of Chicago.\n\n```{r}\n# Calculate performance metrics\ncomparison <- fishnet_data_pd %>%\n  st_drop_geometry() %>%\n  filter(!is.na(pred_nb), !is.na(pred_kde)) %>%\n  summarize(\n    model_mae = mean(abs(cnt_burglaries_2017 - pred_nb)),\n    model_rmse = sqrt(mean((cnt_burglaries_2017 - pred_nb)^2)),\n    kde_mae = mean(abs(cnt_burglaries_2017 - pred_kde)),\n    kde_rmse = sqrt(mean((cnt_burglaries_2017 - pred_kde)^2))\n  )\n\ncomparison %>%\n  pivot_longer(everything(), names_to = \"metric\", values_to = \"value\") %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(\n    digits = 2,\n    caption = \"Model Performance Comparison\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\nThe more complex negative binomial model does not outperform a simple\nKDE baseline, with Mean Absolute Error (MAE) and Root Mean Squared Error\n(RMSE) values both less for the KDE baseline compared to the NB model.\nThis indicates that the added complexity of the NB model might not be\nworth it when based off of 311 calls that report Vacant/Abandoned\nBuildings.\n\n```{r}\n#| fig-width: 10\n#| fig-height: 5\n\n# Calculate errors\nfishnet_data_pd <- fishnet_data_pd %>%\n  mutate(\n    error_nb = cnt_burglaries_2017 - pred_nb,\n    error_kde = cnt_burglaries_2017 - pred_kde,\n    abs_error_nb = abs(error_nb),\n    abs_error_kde = abs(error_kde)\n  )\n\n# Map errors\np1 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name = \"Error\",\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    limits = c(-10, 10)\n  ) +\n  labs(title = \"Model Errors (Actual - Predicted)\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Abs. Error\", option = \"plasma\") +\n  labs(title = \"Absolute Model Errors\") +\n  theme_void()\n\np1 + p2\n```\n\nThe model tends to under-predict burglaries in North Chicago, though\nthere are pockets of under-prediction in South Chicago as well. The\nworst over-prediction occurred in Central Chicago and South Chicago,\nwhere reports of vacant buildings were most common. This reveals that a\ndataset that models for burglaries needs to have a similar extent of\ndata, as the 311 call category chosen for this analysis only spatially\noverlapped with burglaries in a few locations. Recall that of all\nfishnet cells, 32.1% didn't have any value for burglaries while a much\ngreater 64.4% of cells had no value for reports, producing a lot of\ncounts of 0 for reports across a variety of values for burglaries.\n\nThe model coefficients and this analysis of prediction accuracy indicate\nthat while this modeling approach could be improved upon with\nadditional/more complete data to predict burglary distribution better,\nthis model in its current form should not be used to predict for other\nyears.\n","srcMarkdownNoYaml":"\n\nLoad Packages & Set Seed\n\n```{r warning=FALSE}\nlibrary(pacman)\np_load(tidyverse, sf, viridis, terra, spdep, FNN, MASS, spatstat.geom, spatstat.explore,\n       viridis, patchwork, knitr, kableExtra, classInt)\n\nset.seed(1234)\n```\n\n## Introduction\n\nThis analysis will create a spatial predictive model for burglaries in\nChicago, IL based on 311 calls that report the locations of vacant\nand/or abandoned buildings. The hypothesis behind this 311 call category\nchoice is that reports of vacant buildings could indicate areas of the\ncity that are in poor repair (broken lighting, poor street\ncleaning/maintenance, etc.) and with less functional surveillance\nequipment in the area. Please note that there are inherent biases in the\nuse of 311 call data. For example, calls might be less likely to be made\nby marginalized communities who have been historically persecuted by law\nenforcement compared to more white, affluent communities. Furthermore,\nknowledge of how to make 311 calls or what the system's intended purpose\nis might not be equally distributed across Chicago, leading to a spatial\nimbalance of calls across the region.\n\n## Part 1: Data Loading & Exploration\n\nLoading Chicago police districts for cross-validation later on, police\nbeats as a smaller administrative boundary, and the boundary of Chicago\nto create a fishnet, utilizing the coordinate system ESRI: 102271\n(Illinois State Plane East, NAD83, US Feet).\n\n```{r}\n\n# Load police districts (used for spatial cross-validation)\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\", quiet = T) %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n\n# Load police beats (smaller administrative units)\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\", quiet = T) %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n\n# Load Chicago boundary\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\", quiet = T) %>%\n  st_transform('ESRI:102271')\n```\n\nLoad burglaries data:\n\n```{r}\nburglaries <- st_read(\"./data/burglaries.shp\", quiet = T) %>% \n  st_transform('ESRI:102271')\n\n# filter out 2018 burglaries to isolate 2017 data (no other years present)\n# spatially filter to those within Chicago's boundary\nburglaries_2017 <- burglaries %>% \n  filter(year(Date) != 2018) %>% \n  st_filter(chicagoBoundary, .predicate = st_within)\n\ncat(\"Number of Burglaries:\", nrow(burglaries_2017))\n```\n\n```{r}\nggplot() +\n  geom_sf(data = chicagoBoundary, color = \"grey20\", fill = \"transparent\") +\n  geom_sf(data = burglaries_2017, color = \"maroon\", size = 0.25, alpha = 0.1) +\n  labs(title = \"Spatial Distribution of Burglaries\",\n       subtitle = \"Chicago, IL\") +\n  theme_void()\n  \n```\n\nLoad 311 Vacant and/or Abandoned Building reports. This dataset will be\nreferred to as \"Vacant Building Reports\" for the remainder of this\nreport:\n\n```{r}\nreports <- read_csv(\"./data/Vacant_and_Abandoned_Buildings_Reported.csv\", show_col_types = F)\n\n# filter out only 2017 reports\nreports_2017 <- reports %>% \n  filter(endsWith(`DATE SERVICE REQUEST WAS RECEIVED`, \"2017\"))\n\n# filter out 2018 reports for later\nreports_2018 <- reports %>% \n  filter(endsWith(`DATE SERVICE REQUEST WAS RECEIVED`, \"2018\"))\n\n\n```\n\n```{r}\n# remove rows without coordinate data and create a spatial point sf of the reports df\n# filter dataset to the extent of Chicago's boundary\nreports_2017_sf <- reports_2017 %>% \n  filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>% \n  st_as_sf(coords = c(\"LONGITUDE\", \"LATITUDE\"),\n           crs = 4326) %>% \n  st_transform(\"ESRI:102271\") %>% \n  st_filter(chicagoBoundary, .predicate = st_within)\n\n# filter dataset to the extent of Chicago's boundary\nreports_2018_sf <- reports_2018 %>% \n  filter(!is.na(LATITUDE) & !is.na(LONGITUDE)) %>% \n  st_as_sf(coords = c(\"LONGITUDE\", \"LATITUDE\"),\n           crs = 4326) %>% \n  st_transform(\"ESRI:102271\") %>% \n  st_filter(chicagoBoundary, .predicate = st_within)\n\ncat(\"Number of Reports of Vacant/Abandoned Buildings (2017):\", nrow(reports_2017_sf), \"\\n\\n\")\ncat(\"Number of Reports of Vacant/Abandoned Buildings (2018):\", nrow(reports_2018_sf))\n```\n\n```{r}\nggplot() +\n  geom_sf(data = chicagoBoundary, color = \"grey20\", fill = \"transparent\") +\n  geom_sf(data = reports_2017_sf, color = \"orange\", size = 0.1, alpha = 0.1) +\n  geom_sf(data = burglaries_2017, color = \"maroon\", size = 0.25, alpha = 0.2) +\n  labs(title = \"Spatial Distribution of Burglaries and Vacant Building Reports\",\n       subtitle = \"Chicago, IL\") +\n  theme_void()\n```\n\nVisually, burglaries seem to be spatially correlated to the locations of\nvacant building reports. However, the extent of these reports seems to\nextend beyond the greatest concentrations of burglaries, which could\ninfluence the model later on.\n\n## Part 2: Fishnet Grid Creation\n\n```{r}\n# create a 500x500m fishnet based on the chicago boundary\nfishnet <- st_make_grid(chicagoBoundary,\n                        cellsize = 500,\n                        square = T) %>% \n  st_as_sf() %>% \n  mutate(fish_id = row_number()) %>% \n  rename(geometry = x) %>%\n  st_as_sf() %>% \n  st_filter(chicagoBoundary, .predicate = st_intersects)\n```\n\n```{r}\nggplot() +\n  geom_sf(data = chicagoBoundary, color = \"grey20\", fill = \"transparent\") +\n  geom_sf(data = fishnet, color = \"grey50\", fill = \"transparent\") +\n  labs(title = \"500x500m Fishnet Grid for Chicago\") +\n  theme_void()\n```\n\nNow that a fishnet has been created, we can aggregate burglaries and\nvacant building reports to them, visualize them more effectively and\nmodel their correlation with burglaries.\n\n```{r include=FALSE}\n# spatially join fishnet ids to burglary and 311 report records for both 2017 and 2018\n# generate count per fishnet cell\nburglaries_2017_fishnet <- st_join(burglaries_2017, fishnet, join = st_within) %>% \n  st_drop_geometry() %>% \n  group_by(fish_id) %>%\n  summarise(cnt_burglaries_2017 = n())\nreports_2017_fishnet <- st_join(reports_2017_sf, fishnet, join = st_within) %>% \n  st_drop_geometry() %>% \n  group_by(fish_id) %>%\n  summarise(cnt_reports_2017 = n())\nreports_2018_fishnet <- st_join(reports_2018_sf, fishnet, join = st_within) %>% \n  st_drop_geometry() %>% \n  group_by(fish_id) %>%\n  summarise(cnt_reports_2018 = n())\n\n# join values back to the fishnet, replacing NAs with 0\nfishnet_data <- list(fishnet,\n                     burglaries_2017_fishnet,\n                     reports_2017_fishnet,\n                     reports_2018_fishnet) %>% \n  reduce(left_join) %>%\n  mutate(across(where(is.numeric), ~ ifelse(is.na(.), 0, .)))\n```\n\n```{r}\n# transform 2017 data \nfishnet_2017_data_long <- fishnet_data %>%\n  dplyr::select(-cnt_reports_2018) %>% \n  pivot_longer(cols = c(cnt_burglaries_2017, cnt_reports_2017), names_to = \"var\", values_to = \"value\")\n\nggplot(fishnet_2017_data_long) +\n  geom_sf(aes(fill = value), color = NA) +\n  facet_wrap(~ var) +\n  labs(title = \"Distribution of Burglaries and Reports across Chicago\",\n       subtitle = \"Visualized as the Square Root of Counts per Fishnet Cell\") +\n  scale_fill_viridis_c(option = \"plasma\", trans = \"sqrt\",\n                       name = \"Sqrt of Count\") +\n  theme_void()\n```\n\nWhile there seem to be matching areas of high counts in South Chicago,\nthere is a notable lack of reports in North Chicago that do not match\nhigher counts of burglaries in the same area.\n\n```{r}\n# summary statistics for burglaries\ncat(\"Summary Statistics for Burglaries (2017):\\n\")\nsummary(fishnet_data$cnt_burglaries_2017)\ncat(\"Percent of Cells with No Burglaries: \",\n    round(sum(fishnet_data$cnt_burglaries_2017 == 0) / nrow(fishnet_data), 3)*100,\n    \"%\\n\\n\",\n    sep = \"\")\n\n# summary statistics for reports 2017\ncat(\"Summary Statistics for Vacant Building Reports (2017):\\n\")\nsummary(fishnet_data$cnt_reports_2017)\ncat(\"Percent of Cells with No Vacant Building Reports: \",\n    round(sum(fishnet_data$cnt_reports_2017 == 0) / nrow(fishnet_data), 3)*100,\n    \"%\\n\\n\",\n    sep = \"\")\n\n# summary statistics for reports 2018\ncat(\"Summary Statistics for Vacant Building Reports (2018):\\n\")\nsummary(fishnet_data$cnt_reports_2018)\ncat(\"Percent of Cells with No Vacant Building Reports: \",\n    round(sum(fishnet_data$cnt_reports_2018 == 0) / nrow(fishnet_data), 3)*100,\n    \"%\\n\\n\",\n    sep = \"\")\n```\n\nThere are approximately twice as many fishnet cells for both 2017 and\n2018 that have no vacant building reports compared to those that have no\nburglaries, which is indicative of the wider spatial distribution of\nburglaries.\n\n## Part 3: Spatial Features\n\n### 3.1 - Kernel Density Estimation of Burglaries\n\nCalculate a Kernel Density Estimation (KDE) baseline as a null\nhypothesis to demonstrate a scenario where burglaries occur in 2018\nsimply where they happened to occur in 2017. KDE spreads the value of a\npoint (a single burglary) over a radius (1 kilometer) with the greatest\nshare of the value close to the center of the point. By taking the mean\nvalue within a fishnet cell, we can get a distance-weighted, smoothed\nsense for how concentrated burglaries are in an area.\n\n```{r}\n\n# convert burglaries to ppp format for use with the spatstat package\nburglaries_2017_ppp <- as.ppp(st_coordinates(burglaries_2017),\n                         W = as.owin(st_bbox(chicagoBoundary)))\n\n# calculate KDE values for burglary points\nkde_burglaries <- density.ppp(burglaries_2017_ppp,\n                              sigma = 1000,\n                              edge = T)\n\n# convert KDE values to a raster\nkde_raster <- rast(kde_burglaries)\n\n# extract mean KDE values from the spatial raster to the fishnet grid\nfishnet_data <- fishnet_data %>% \n  mutate(kde_value = terra::extract(kde_raster,\n                                    vect(fishnet_data),\n                                    fun = mean,\n                                    na.rm = T)[,2])\n```\n\n```{r}\nggplot() +\n  geom_sf(data = fishnet_data, aes(fill = kde_value), color = NA) +\n  scale_fill_viridis_c(name = \"KDE Value\",\n                       option = \"plasma\") +\n  labs(title = \"Kernel Density Estimation Baseline\",\n       subtitle = \"Simple spatial smoothing of burglary locations\") +\n  theme_void()\n```\n\nThe KDE yields a map of burglary hot spots, where the influence of each\nburglary has been smoothed out and averaged. This provides a good sense\nof where generally burglaries happen, but this method also\nover-estimates where burglaries happen due to the indiscriminate nature\nof smoothing over a uniform 1km buffer.\n\n### 3.2 - k-Nearest Neighbor to Reports\n\n```{r warning=FALSE}\n\n# calculate coordinates of fishnet cells and the report locations\nfishnet_coords <- st_coordinates(st_centroid(fishnet_data))\nreports_coords <- st_coordinates(st_centroid(reports_2017_sf))\n\n# calculate k nearest neighbors and distances\nnn_result <- get.knnx(reports_coords, fishnet_coords, k = 3)\n\n# join values to the fishnet\nfishnet_data <- fishnet_data %>% \n  mutate(knn_reports_2017 = rowMeans(nn_result$nn.dist))\n\nsummary(fishnet_data$knn_reports_2017)\n```\n\nThe mean distance from the center of a fishnet cell to a report of a\nvacant building is approximately 790 meters. The value for k-nearest\nneighbor is an indicator of the average distance to the closest three\nreports of a vacant building. This is more descriptive than a simple\ncount within a fishnet cell's boundary since, for those that have no\nreports within them, there will still be a descriptive distance value to\nthe nearest reports.\n\n### 3.3 - Distance to Hot Spots (Local Moran's I)\n\n```{r warning=FALSE}\ncalc_local_morans <- function(data, var, k) {\n  coords <- st_coordinates(st_centroid(data))\n  neighbors <- knn2nb(knearneigh(coords, k = k))\n  weights <- nb2listw(neighbors, style = \"W\", zero.policy = T)\n  \n  local_moran <- localmoran(data[[var]], weights)\n  \n  mean_val <- mean(data[[var]], na.rm = T)\n  \n  data %>% \n    mutate(local_i = local_moran[,1],\n           p_value = local_moran[,5],\n           is_sig = p_value < 0.05,\n           moran_class = case_when(!is_sig ~ \"Not Significant\",\n                                   local_i > 0 & .data[[var]] > mean_val ~ \"High-High\",\n                                   local_i > 0 & .data[[var]] <= mean_val ~ \"Low-Low\",\n                                   local_i < 0 & .data[[var]] > mean_val ~ \"High-Low\",\n                                   local_i < 0 & .data[[var]] <= mean_val ~ \"Low-High\",\n                                   TRUE ~ \"Not Significant\"))\n}\n\n# calculate local moran's I for vacant building reports in 2017\nfishnet_data <- calc_local_morans(data = fishnet_data,\n                                  var = \"cnt_reports_2017\",\n                                  k = 5)\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 6\n\n# Visualize hot spots\nggplot() +\n  geom_sf(\n    data = fishnet_data, \n    aes(fill = moran_class), \n    color = NA\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"High-High\" = \"#d7191c\",\n      \"High-Low\" = \"#fdae61\",\n      \"Low-High\" = \"#abd9e9\",\n      \"Low-Low\" = \"#2c7bb6\",\n      \"Not Significant\" = \"gray90\"\n    ),\n    name = \"Cluster Type\"\n  ) +\n  labs(\n    title = \"Local Moran's I: Vacant/Abandoned Building Report Clusters\",\n    subtitle = \"High-High = Hot spots of disorder\"\n  ) +\n  theme_void()\n```\n\n```{r warning=FALSE}\nhotspots <- fishnet_data %>% \n  filter(moran_class == \"High-High\") %>% \n  st_centroid()\n\n# calculate distance from each cell to the nearest hot spot\nif (nrow(hotspots) > 0) {\n  fishnet_data <- fishnet_data %>% \n    mutate(dist_to_hotspot = as.numeric(st_distance(st_centroid(fishnet_data),\n                                                    hotspots %>% \n                                                      st_union())))\n  cat(\"Number of hot spot cells:\", nrow(hotspots), \"\\n\\n\")\n} else{\n  fishnet_data <- fishnet_data %>% \n    mutate(dist_to_hotspot = 0)\n  cat(\"No significant hot spots found \\n\\n\")\n}\n\ncat(\"Summary statistics of Distance to Hot Spot:\\n\")\nsummary(fishnet_data$dist_to_hotspot)\n```\n\nIn this scenario, Local Moran's I is a measurement of how spatially\ncorrelated burglary counts and report counts are, with fishnet cells\nthat themselves have high values for both variables and are located near\nfishnet cells with similarly high values are denoted as \"high-high\"\ncells, or hot spots. Cells for which the converse is true (low values\nfor both) are referred to as cold spots. Analyzing how significant this\nspatial correlation is and calculating the distance of each fishnet cell\nto its closest neighboring hot spot cell allows for us to understand how\neach cell is related to more regional spatial patterns, as opposed to\nthe k-nearest neighbors variable which illustrates hyper-localized\nspatial patterns.\n\n## Part 4: Count Regression Models\n\n### 4.1 - Join police districts for cross-validation later on\n\n```{r}\nfishnet_data_pd <- st_join(fishnet_data,\n                        policeDistricts,\n                        join = st_within,\n                        left = T) %>% \n  filter(!is.na(District))\n\nggplot() +\n  geom_sf(data = fishnet_data, fill = \"grey90\", color = \"grey30\", alpha = 0.5) +\n  geom_sf(data = fishnet_data_pd, fill = \"maroon\", color = NA, alpha = 0.3) +\n  labs(title = \"Visualizing Fishnet Cell Loss\",\n       subtitle = \"Black = Original Fishnet, Red = Trimmed Fishnet\") +\n  theme_void()\n```\n\n```{r}\ncat(\"Fishnet Cell Count Prior to Filtering:\", nrow(fishnet_data), \"\\n\\n\")\ncat(\"Fishnet Cell Count After Filtering:\", nrow(fishnet_data_pd), \"\\n\\n\")\ncat(\"Cell Loss Percent: \",\n    (1-round(nrow(fishnet_data_pd)/nrow(fishnet_data), 3))*100,\n    \"%\",\n    sep = \"\")\n```\n\nIn order to accurately perform spatial cross-validation later in the\nanalysis, we need to isolate only those fishnet cells that are entirely\nwithin each of Chicago's police districts. This results in an\napproximately 30% loss in data, with 750 cells omitted.\n\n### 4.2 - Poisson Regression\n\nPoisson Regression is optimal for this modeling approach, since the\ndependent variable (burglaries) is a count variable.\n\n```{r}\n# extract variables to be used for modeling and remove spatial column\nfishnet_model <- fishnet_data_pd %>%\n  st_drop_geometry() %>% \n  dplyr::select(fish_id,\n                District,\n                cnt_burglaries_2017,\n                cnt_reports_2017,\n                knn_reports_2017,\n                dist_to_hotspot) %>% \n  na.omit()\n```\n\n```{r}\n# fit poisson regression model for 2017\nmodel_poisson <- fishnet_model %>% \n  glm(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,\n      data = .,\n      family = \"poisson\")\n\nsummary(model_poisson)\n```\n\nA poisson regression analysis yields coefficients that are positive for\nthe count of reports and distance to the nearest hot spot cell\nvariables, while negative for the k-nearest neighbor variable. These\ncoefficients make sense for the count variable (greater count of reports\n= increased likelihood of burglaries) and the k-nearest neighbor\nvariable (greater distance to a report = greater of burglaries).\nHowever, the coefficient for distance to a hot spot does not make sense\n(increased distance to a hots pot = more instances of burglaries). This\ncoefficient also is not statistically significant (p \\> 0.05) and has a\nhigh standard error value equivalent to 86.5% of the coefficient.\n\n### 6.2 - Check for Overdispersion\n\n```{r}\ndispersion <- sum(residuals(model_poisson,\n                            type = \"pearson\")^2) / model_poisson$df.residual\ncat(\"Dispersion Parameter:\", round(dispersion, 2), \"\\n\")\ncat(\"Rule of Thumb: >1.5 typically suggests overdispersion \\n\")\n\nif (dispersion > 1.5) {\n  cat(\"⚠ Overdispersion detected! Consider Negative Binomial model.\\n\")\n} else {\n  cat(\"✓ Dispersion looks okay for Poisson model.\\n\")\n}\n```\n\nThis model violates the assumption that the mean of the dependent\nvariable is equal to its variance, which is typically not true for crime\ndatasets. A negative binomial model should be calculated to see if it\npredicts better.\n\n### 6.3 - Negative Binomial Regression\n\n```{r}\n# fit a negative binomial model\nmodel_nb <- fishnet_data_pd %>%\n  glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,\n         data = .)\n\nsummary(model_nb)\n\n# compare the AIC scores of both models (lower is better)\ncat(\"\\n\\nModel Comparison:\\n\", \n    \"Poisson AIC:\", round(AIC(model_poisson), 1), \"\\n\",\n    \"Negative Binomial AIC:\", round(AIC(model_nb), 1))\n```\n\nThe negative binomial model has an improved AIC value, and while its\ncoefficients follow the same sign pattern as before where the sign for\ndistance to the nearest hot spot doesn't make sense, it is now\nsignificant (p \\< 0.05) with a standard error that is slightly improved\nat 50.4% of the coefficient value. This tells us that the negative\nbinomial model is better at modeling burglary counts since it introduces\na dispersion parameter that relaxes the assumption of the poisson\nregression that mean = variance.\n\n## Part 5: Spatial Cross-Validation (2017)\n\nIn order to prevent information leakage between neighboring fishnet\ncells in a normal cross-validation procedure due their spatial\nrelationships to each other, the following code performs a\nLeave-One-Group-Out (LOGO) Cross-Validation that will divide the dataset\nup based on police district and progressively leave each one out one by\none, training a negative binomial model on the remaining districts.\n\n```{r}\ndistricts <- unique(fishnet_model$District)\ncv_results <- tibble()\n\nfor (i in seq_along(districts)) {\n  test_district <- districts[i]\n  \n  # split into training and testing data\n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data <- fishnet_model %>% filter(District == test_district)\n  \n  # fit model on training data\n  model_cv <- fishnet_model %>%\n    glm.nb(cnt_burglaries_2017 ~ \n           cnt_reports_2017 + \n           knn_reports_2017 + \n           dist_to_hotspot,\n           data = .)\n  \n  # predict on test data\n  test_data <- test_data %>% \n    mutate(pred = predict(model_cv, test_data, type = \"response\"))\n  \n  # calculate metrics\n  mae <- mean(abs(test_data$cnt_burglaries_2017 - test_data$pred))\n  rmse <- sqrt(mean((test_data$cnt_burglaries_2017 - test_data$pred)^2))\n  \n  # store results\n  cv_results <- bind_rows(cv_results,\n                          tibble(fold = i,\n                                 test_district = test_district,\n                                 n_test = nrow(test_data),\n                                 mae = mae,\n                                 rmse = rmse))\n}\n```\n\n```{r}\n# view results of the spatial cross-validation\ncv_results %>% \n  arrange(desc(mae)) %>% \n  kable(digits = 2,\n       caption = \"LOGO CV Results by Police District\") %>% \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n## Part 6: Model Evaluation\n\n### 6.1 - Generate Final Predictions\n\n```{r}\n# fit final model on all data\nfinal_model <- fishnet_model %>% \n  glm.nb(cnt_burglaries_2017 ~ cnt_reports_2017 + knn_reports_2017 + dist_to_hotspot,\n         data = .)\n\n# add predictions to the fishnet\nfishnet_data_pd <- fishnet_data_pd %>% \n  mutate(pred_nb = predict(final_model, fishnet_model, type = \"response\")[match(fish_id, fishnet_model$fish_id)])\n\n# add KDE predictions (normalized to the same scale as counts)\nkde_sum <- sum(fishnet_data_pd$kde_value, na.rm = T)\ncount_sum <- sum(fishnet_data_pd$cnt_burglaries_2017, na.rm = T)\nfishnet_data_pd <- fishnet_data_pd %>% mutate(pred_kde = (kde_value/kde_sum) * count_sum)\n```\n\n```{r}\n# create a summary table of the model's coefficients\nmodel_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%\n  mutate(\n    across(where(is.numeric), ~round(., 3))\n  )\n\nmodel_summary %>%\n  kable(\n    caption = \"Final Negative Binomial Model Coefficients (Exponentiated)\",\n    col.names = c(\"Variable\", \"Rate Ratio\", \"Std. Error\", \"Z\", \"P-Value\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\")) %>%\n  footnote(\n    general = \"Rate ratios > 1 indicate positive association with burglary counts.\"\n  )\n```\n\nThe final model coefficients, when exponentiated, indicate that within a\nfishnet cell an increase of one report of an abandoned/vacant building\nresults in a 4.6% increase in burglaries, a one unit increase in mean\ndistance from the centroid of a fishnet cell to the nearest three\nreports of an abandoned/vacant building results in a 0.1% decrease in\nburglaries, and distance to the nearest hot spot has no effect on the\nnumber of burglaries within that fishnet cell.\n\n```{r}\n#| fig-width: 12\n#| fig-height: 4\n\n# Create three maps\np1 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = cnt_burglaries_2017), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Actual Burglaries\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = pred_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Model Predictions (Neg. Binomial)\") +\n  theme_void()\n\np3 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = pred_kde), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"KDE Baseline Predictions\") +\n  theme_void()\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Actual vs. Predicted Burglaries\",\n    subtitle = \"Does our complex model outperform simple KDE?\"\n  )\n```\n\nIt does not appear that the negative binomial model is doing a good job\nof predicting burglaries in North Chicago, as was previously noted in\nthis report. The negative binomial model also generally seems to be\nunder-predicting counts across all of Chicago.\n\n```{r}\n# Calculate performance metrics\ncomparison <- fishnet_data_pd %>%\n  st_drop_geometry() %>%\n  filter(!is.na(pred_nb), !is.na(pred_kde)) %>%\n  summarize(\n    model_mae = mean(abs(cnt_burglaries_2017 - pred_nb)),\n    model_rmse = sqrt(mean((cnt_burglaries_2017 - pred_nb)^2)),\n    kde_mae = mean(abs(cnt_burglaries_2017 - pred_kde)),\n    kde_rmse = sqrt(mean((cnt_burglaries_2017 - pred_kde)^2))\n  )\n\ncomparison %>%\n  pivot_longer(everything(), names_to = \"metric\", values_to = \"value\") %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(\n    digits = 2,\n    caption = \"Model Performance Comparison\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\nThe more complex negative binomial model does not outperform a simple\nKDE baseline, with Mean Absolute Error (MAE) and Root Mean Squared Error\n(RMSE) values both less for the KDE baseline compared to the NB model.\nThis indicates that the added complexity of the NB model might not be\nworth it when based off of 311 calls that report Vacant/Abandoned\nBuildings.\n\n```{r}\n#| fig-width: 10\n#| fig-height: 5\n\n# Calculate errors\nfishnet_data_pd <- fishnet_data_pd %>%\n  mutate(\n    error_nb = cnt_burglaries_2017 - pred_nb,\n    error_kde = cnt_burglaries_2017 - pred_kde,\n    abs_error_nb = abs(error_nb),\n    abs_error_kde = abs(error_kde)\n  )\n\n# Map errors\np1 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name = \"Error\",\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    limits = c(-10, 10)\n  ) +\n  labs(title = \"Model Errors (Actual - Predicted)\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet_data_pd, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Abs. Error\", option = \"plasma\") +\n  labs(title = \"Absolute Model Errors\") +\n  theme_void()\n\np1 + p2\n```\n\nThe model tends to under-predict burglaries in North Chicago, though\nthere are pockets of under-prediction in South Chicago as well. The\nworst over-prediction occurred in Central Chicago and South Chicago,\nwhere reports of vacant buildings were most common. This reveals that a\ndataset that models for burglaries needs to have a similar extent of\ndata, as the 311 call category chosen for this analysis only spatially\noverlapped with burglaries in a few locations. Recall that of all\nfishnet cells, 32.1% didn't have any value for burglaries while a much\ngreater 64.4% of cells had no value for reports, producing a lot of\ncounts of 0 for reports across a variety of values for burglaries.\n\nThe model coefficients and this analysis of prediction accuracy indicate\nthat while this modeling approach could be improved upon with\nadditional/more complete data to predict burglary distribution better,\nthis model in its current form should not be used to predict for other\nyears.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"show","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"embed-resources":true,"output-file":"Sywulak-Herr_Henry_assignment4.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.24","theme":"cosmo","title":"Assignment 4: Spatial Predictive Analysis","subtitle":"Predictive Spatial Modeling for 311 Service Requests in Chicago","author":"Henry Sywulak-Herr","date":"today","editor":{"markdown":{"wrap":72}},"toc-location":"left"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}