# x-value of the right side of distribution is roughly 5
# e^5 is equal to 150, or 2.5 hours trip duration
cumulative_pcts <- data.frame(hour = seq(1:24),
cumulative_pct = sapply(seq(1:24), function(x){
round(sum(indego$duration <= x*60)/nrow(indego)*100, 2)
}))
ggplot(data = cumulative_pcts) +
geom_line(aes(x = hour, y = cumulative_pct),
colour = colors[3],
linewidth = 1) +
labs(title = "Cumulative Percent of Trips Within a Given Duration",
x = "Duration (hrs)",
y = "Cumulative Pct") +
scale_x_continuous(breaks = seq(0, 24, 2)) +
theme_minimal()
# remove trips greater than 12 hours in duration
indego <- indego %>%
filter(duration < 720)
cat("Cumulative Percent of Entries Removed: ",
round((1-(nrow(indego)/original_trip_total))*100, 2), "%",
sep = "")
# identify which trips started and ended at the same station
# note that this is a sanity check, all should have trip_route_category == "Round Trip"
round_trips <- indego %>%
filter(start_station == end_station)
table(round_trips$trip_route_category)
round_trips_short <- round_trips %>%
filter(duration < 30)
hist(round_trips_short$duration,
breaks = 30,
col = colors[2],
border = colors[4],
main = "Histogram of Round Trip Durations (<30 min trips only)",
xlab = "Duration (mins)")
# simpler Empirical Cumulative Density Function (ecdf) plot used here due to lower quantity of data
ecdf(round_trips_short$duration) %>%
plot(main = "ECDF Plot of Round Trip Duration",
xlab = "Duration (mins)",
ylab = "CDF")
cat("Count of Round Trips Lasting 1 Minute: ",
sum(round_trips$duration == 1),
"\n\nPercent of Round Trips Lasting 1 Minute: ",
sum(round_trips$duration == 1)/nrow(round_trips),
"\n\n1-Minute Round Trips - Percent of Original Trip Count: ",
sum(round_trips$duration == 1)/original_trip_total*100,
sep = "")
# filter out round trips less than 5 minutes long
indego <- indego %>%
filter(!(duration < 5 & trip_route_category == "Round Trip"))
cat("Cumulative Percent of Entries Removed: ",
round((1-(nrow(indego)/original_trip_total))*100, 2), "%",
sep = "")
# Daily trip counts
daily_trips <- indego %>%
group_by(date) %>%
summarize(trips = n())
ggplot(daily_trips, aes(x = date, y = trips)) +
geom_line(color = colors[1], linewidth = 1) +
geom_smooth(se = FALSE, color = colors[3], linetype = "dashed") +
labs(
title = "Indego Daily Ridership - 2024",
subtitle = "Annual demand patterns in Philadelphia",
x = "Date",
y = "Daily Trips",
caption = "Source: Indego bike share") +
theme_classic()
# Average trips by hour and day type
hourly_patterns <- indego %>%
group_by(hour, weekend) %>%
summarize(avg_trips = n() / n_distinct(date)) %>%
mutate(day_type = ifelse(weekend == 1, "Weekend", "Weekday"))
ggplot(hourly_patterns, aes(x = hour, y = avg_trips, color = day_type)) +
geom_line(linewidth = 1.2) +
scale_color_manual(values = c("Weekday" = "#08519c", "Weekend" = "#6baed6")) +
labs(
title = "Average Hourly Ridership Patterns",
subtitle = "Clear commute patterns on weekdays",
x = "Hour of Day",
y = "Average Trips per Hour",
color = "Day Type"
) +
theme_minimal()
# Most popular origin stations
top_stations <- indego %>%
count(start_station, start_lat, start_lon, name = "trips") %>%
arrange(desc(trips)) %>%
head(20)
kable(top_stations,
caption = "Top 20 Indego Stations by Trip Origins",
format.args = list(big.mark = ",")) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Get Philadelphia census tracts
philly_census <- get_acs(
geography = "tract",
variables = c(
"B01003_001",  # Total population
"B19013_001",  # Median household income
"B08301_001",  # Total commuters
"B08301_010",  # Commute by transit
"B02001_002",  # White alone
"B25077_001"   # Median home value
),
state = "PA",
county = "Philadelphia",
year = 2022,
geometry = TRUE,
output = "wide",
progress_bar = F
) %>%
rename(
Total_Pop = B01003_001E,
Med_Inc = B19013_001E,
Total_Commuters = B08301_001E,
Transit_Commuters = B08301_010E,
White_Pop = B02001_002E,
Med_Home_Value = B25077_001E
) %>%
mutate(
Percent_Taking_Transit = (Transit_Commuters / Total_Commuters) * 100,
Percent_White = (White_Pop / Total_Pop) * 100
) %>%
st_transform(crs = 4326)
# create a unified philadelphia geometry
phl_boundary <- philly_census %>% select(-everything()) %>%
st_union() %>%
st_as_sf() %>%
st_transform(2272)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272)
ggplot() +
geom_sf(data = phl_boundary,
color = colors[3],
fill = colors[4]) +
geom_sf()
st_crs(phl_boundary) == st_crs(stn_points)
test <- st_intersects(stn_points, phl_boundary)
View(test)
test <- stn_points %>%
mutate(in_phl = lenghts(st_intersects(stn_points, phl_boundary)))
test <- stn_points %>%
mutate(in_phl = lengths(st_intersects(stn_points, phl_boundary)))
lengths(st_intersects(stn_points, phl_boundary))
length(st_intersects(stn_points, phl_boundary)[1])
test <- stn_points %>%
mutate(in_phl = length(st_intersects(stn_points, phl_boundary)))
sum(st_intersects(stn_points, phl_boundary)[1])
lengths(st_intersects(stn_points, phl_boundary)[1])
test <- stn_points %>%
mutate(in_phl = lengths(st_intersects(stn_points, phl_boundary)))
test <- stn_points %>%
cbind(lengths(st_intersects(stn_points, phl_boundary)))
View(test)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
test <- stn_points %>%
mutate(in_phl = lengths(st_intersects(., phl_boundary)))
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
test <- stn_points %>%
mutate(in_phl = lengths(st_within(., phl_boundary)) > 0)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
test <- stn_points %>%
mutate(in_phl = lengths(st_within(., phl_boundary)) > 0)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
test <- stn_points %>%
mutate(in_phl = lengths(st_within(., phl_boundary)) > 0)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
test <- stn_points %>%
mutate(in_phl = lengths(st_within(., phl_boundary)) > 0)
# knitr::opts_chunk$set(
#   warning = FALSE,
#   message = FALSE
# )
# load all packages for analysis
library(pacman)
p_load(tidyverse, lubridate, openxlsx,
sf, tigris, tidycensus,
riem,
viridis, gridExtra, knitr, kableExtra)
colors <- c("#93d500", "#0082ca", "#002169", "#e6e6e6")
# save path to data files
path <- "./data/indego-trips/"
# load all trip csvs for the four quarters
indego <- lapply(list.files(path, full.names = T),
function(x) {
data <- read_csv(file = x, show_col_types = F)
data <- data %>%
mutate(quarter = sub(".*-(q[0-9])\\.csv$", "\\1", x))
return(data)
}
) %>% do.call(rbind, .)
original_trip_total <- nrow(indego)
# identify where NAs are coming from in the dataset
na_counts <- sapply(indego, function(x) sum(is.na(x)))
na_counts[na_counts > 0] %>%
kable(col.names = c("Column", "Count"))
# Confirm that station ID 3000 is always associated with NAs for lat/lon
station_3000 <- indego %>%
filter((start_station == 3000 | end_station == 3000) &
(!is.na(start_lon) & !is.na(end_lon)))
cat("Count of Station ID 3000 Trips with Associated Coordinates:",
nrow(station_3000))
# filter out trips starting or ending from station ID 3000
indego <- indego %>%
filter(start_station != 3000 & end_station != 3000)
cat("Cumulative Percent of Entries Removed: ",
round((1-(nrow(indego)/original_trip_total))*100, 2), "%\n\n",
sep = "")
# check for nas across all columns within the entire dataset
ifelse(anyNA(indego), "NAs present", "No NAs present in the dataset")
indego <- indego %>%
mutate(
# Parse datetime
start_datetime = mdy_hm(start_time),
end_datetime = mdy_hm(end_time),
# Create hourly bins
interval60 = floor_date(start_datetime, unit = "hour"),
# Extract time features
week = week(interval60),
month = month(interval60, label = TRUE),
dotw = wday(interval60, label = TRUE),
hour = hour(interval60),
date = as.Date(interval60),
# Create useful indicators
weekend = ifelse(dotw %in% c("Sat", "Sun"), 1, 0),
rush_hour = ifelse(hour %in% c(7, 8, 9, 16, 17, 18), 1, 0)
)
# number of trips
cat("Annual Trip Count:", nrow(indego), "\n")
# date range
cat("Date range:",
as.character(min(mdy_hm(indego$start_time))), "to",
as.character(max(mdy_hm(indego$start_time))), "\n")
# unique station ids across both start and end station columns
unique_stations <- unique(c(indego$start_station, indego$end_station))
cat("Unique stations:",  length(unique_stations), "\n")
# trip types
kable(table(indego$trip_route_category),
col.names = c("Trip Type", "Count"))
# passholder types
kable(table(indego$passholder_type),
col.names = c("Passholder Type", "Count"))
biketypes <- round(table(indego$bike_type)*100 / sum(table(indego$bike_type)), 1)
kable(biketypes,
col.names = c("Bike Type", "Percent"))
# summarize trip duration by week
weekly_summary <- indego %>%
group_by(week, month) %>%
summarise(mean_dur = mean(duration),
median_dur = median(duration),
min_dur = min(duration),
max_dur = max(duration)) %>%
pivot_longer(cols = colnames(.)[-c(1:2)], names_to = "var", values_to = "value")
# create a faceted plot of summary statistics
ggplot() +
geom_line(data = weekly_summary,
mapping = aes(x = week, y = value),
color = colors[1],
linewidth = 1) +
facet_wrap(~var, scales = "free_y") +
labs(title = "Weekly Summary Statistics of Trip Duration", x = "Week (1-53)", y = "Value") +
scale_x_continuous(breaks = seq(1, 53, 4)) +
theme_minimal()
hist(log(indego$duration), breaks = 50, col = colors[2], border = colors[4],
main = "Histogram of Log Duration",
xlab = "Log of Duration in Minutes",
xlim = c(0,8))
# x-value of the right side of distribution is roughly 5
# e^5 is equal to 150, or 2.5 hours trip duration
cumulative_pcts <- data.frame(hour = seq(1:24),
cumulative_pct = sapply(seq(1:24), function(x){
round(sum(indego$duration <= x*60)/nrow(indego)*100, 2)
}))
ggplot(data = cumulative_pcts) +
geom_line(aes(x = hour, y = cumulative_pct),
colour = colors[3],
linewidth = 1) +
labs(title = "Cumulative Percent of Trips Within a Given Duration",
x = "Duration (hrs)",
y = "Cumulative Pct") +
scale_x_continuous(breaks = seq(0, 24, 2)) +
theme_minimal()
# remove trips greater than 12 hours in duration
indego <- indego %>%
filter(duration < 720)
cat("Cumulative Percent of Entries Removed: ",
round((1-(nrow(indego)/original_trip_total))*100, 2), "%",
sep = "")
# identify which trips started and ended at the same station
# note that this is a sanity check, all should have trip_route_category == "Round Trip"
round_trips <- indego %>%
filter(start_station == end_station)
table(round_trips$trip_route_category)
round_trips_short <- round_trips %>%
filter(duration < 30)
hist(round_trips_short$duration,
breaks = 30,
col = colors[2],
border = colors[4],
main = "Histogram of Round Trip Durations (<30 min trips only)",
xlab = "Duration (mins)")
# simpler Empirical Cumulative Density Function (ecdf) plot used here due to lower quantity of data
ecdf(round_trips_short$duration) %>%
plot(main = "ECDF Plot of Round Trip Duration",
xlab = "Duration (mins)",
ylab = "CDF")
cat("Count of Round Trips Lasting 1 Minute: ",
sum(round_trips$duration == 1),
"\n\nPercent of Round Trips Lasting 1 Minute: ",
sum(round_trips$duration == 1)/nrow(round_trips),
"\n\n1-Minute Round Trips - Percent of Original Trip Count: ",
sum(round_trips$duration == 1)/original_trip_total*100,
sep = "")
# filter out round trips less than 5 minutes long
indego <- indego %>%
filter(!(duration < 5 & trip_route_category == "Round Trip"))
cat("Cumulative Percent of Entries Removed: ",
round((1-(nrow(indego)/original_trip_total))*100, 2), "%",
sep = "")
# Daily trip counts
daily_trips <- indego %>%
group_by(date) %>%
summarize(trips = n())
ggplot(daily_trips, aes(x = date, y = trips)) +
geom_line(color = colors[1], linewidth = 1) +
geom_smooth(se = FALSE, color = colors[3], linetype = "dashed") +
labs(
title = "Indego Daily Ridership - 2024",
subtitle = "Annual demand patterns in Philadelphia",
x = "Date",
y = "Daily Trips",
caption = "Source: Indego bike share") +
theme_classic()
# Average trips by hour and day type
hourly_patterns <- indego %>%
group_by(hour, weekend) %>%
summarize(avg_trips = n() / n_distinct(date)) %>%
mutate(day_type = ifelse(weekend == 1, "Weekend", "Weekday"))
ggplot(hourly_patterns, aes(x = hour, y = avg_trips, color = day_type)) +
geom_line(linewidth = 1.2) +
scale_color_manual(values = c("Weekday" = "#08519c", "Weekend" = "#6baed6")) +
labs(
title = "Average Hourly Ridership Patterns",
subtitle = "Clear commute patterns on weekdays",
x = "Hour of Day",
y = "Average Trips per Hour",
color = "Day Type"
) +
theme_minimal()
# Most popular origin stations
top_stations <- indego %>%
count(start_station, start_lat, start_lon, name = "trips") %>%
arrange(desc(trips)) %>%
head(20)
kable(top_stations,
caption = "Top 20 Indego Stations by Trip Origins",
format.args = list(big.mark = ",")) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Get Philadelphia census tracts
philly_census <- get_acs(
geography = "tract",
variables = c(
"B01003_001",  # Total population
"B19013_001",  # Median household income
"B08301_001",  # Total commuters
"B08301_010",  # Commute by transit
"B02001_002",  # White alone
"B25077_001"   # Median home value
),
state = "PA",
county = "Philadelphia",
year = 2022,
geometry = TRUE,
output = "wide",
progress_bar = F
) %>%
rename(
Total_Pop = B01003_001E,
Med_Inc = B19013_001E,
Total_Commuters = B08301_001E,
Transit_Commuters = B08301_010E,
White_Pop = B02001_002E,
Med_Home_Value = B25077_001E
) %>%
mutate(
Percent_Taking_Transit = (Transit_Commuters / Total_Commuters) * 100,
Percent_White = (White_Pop / Total_Pop) * 100
) %>%
st_transform(crs = 4326)
# create a unified philadelphia geometry
phl_boundary <- philly_census %>% select(-everything()) %>%
st_union() %>%
st_as_sf() %>%
st_transform(2272)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
test <- stn_points %>%
mutate(in_phl = lengths(st_within(., phl_boundary)) > 0)
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272)
test <- stn_points %>%
mutate(in_phl = lengths(st_within(., phl_boundary)) > 0)
test <- stn_points %>%
cbind(lengths(st_within(., phl_boundary)))
View(test)
test <- stn_points %>%
cbind(lengths(st_within(., phl_boundary))) %>%
rename("in_phl" = "lengths(st_within(., phl_boundary))")
test <- stn_points %>%
cbind(lengths(st_within(., phl_boundary))) %>%
rename(in_phl = lengths(st_within(., phl_boundary)))
test <- stn_points %>%
cbind(lengths(st_within(., phl_boundary)))
test <- stn_points %>%
cbind(lengths(st_within(., phl_boundary)), x1 = "in_phl")
test <- stn_points %>%
cbind(in_phl = lengths(st_within(., phl_boundary)))
# create stations point shapefile
stn_points <- indego %>%
select(start_station, start_lat, start_lon) %>%
group_by(start_station) %>%
slice_head(n=1) %>%
st_as_sf(coords = c("start_lon", "start_lat"), crs = 4326) %>%
st_transform(2272) %>%
cbind(in_phl = lengths(st_within(., phl_boundary)))
View(stn_points)
table(stn_points$in_phl)
non_phl_station <- stn_points[stn_points$in_phl == 0, "start_station"]
View(non_phl_station)
non_phl_station <- stn_points[stn_points$in_phl == 0, "start_station"] %>% st_drop_geometry()
non_phl_station <- stn_points[stn_points$in_phl == 0, "start_station"] %>% st_drop_geometry() %>% as.numeric()
test <- indego %>%
filter(start_station != non_phl_station & end_station != non_phl_station)
nrow(test) / indego
nrow(test) / nrow(indego)
nrow(test) - nrow(indego)
unique(test$start_station)
# filter out trips to/from this station
test <- indego %>%
filter(start_station != non_phl_station & end_station != non_phl_station)
unique(test$start_station) %>% nrow
unique(test$start_station) %>% length
unique(test$end_station) %>% length
# filter this station from the stn_points sf
stn_points_filt <- stn_points %>%
filter(in_phl > 0)
# visualize stations
ggplot() +
geom_sf(data = phl_boundary,
color = "grey20",
fill = colors[4]) +
geom_sf(data - stn_points_filt,
color = colors[3]) +
theme_void()
# visualize stations
ggplot() +
geom_sf(data = phl_boundary,
color = "grey20",
fill = colors[4]) +
geom_sf(data - stn_points_filt,
color = colors[3]) +
theme_void()
